<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>USDC/USDT Spreads (Jupiter • AlphaQ only)</title>
  <style>
    body { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; padding: 20px; }
    table { border-collapse: collapse; width: 720px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: right; }
    th { text-align: left; }
    .small { color:#666; font-size: 12px; margin-top: 10px; }
    .err { color:#b00020; }
    .ok  { color:#0b6b0b; }
    button { font-family: inherit; padding: 6px 10px; margin-left: 8px; }
    code { background: #f6f6f6; padding: 2px 4px; border-radius: 4px; }
  </style>
</head>
<body>
  <h2>USDC/USDT spread (bps) via Jupiter quotes — <b>AlphaQ only</b></h2>

  <div class="small">
    Host: <code id="hostState">—</code> • API key: <span id="keyState">checking…</span>
    <button id="setKeyBtn" type="button">Set API key</button>
    <button id="clearKeyBtn" type="button">Clear</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Size (USD)</th>
        <th>Bid (USDT/USDC)</th>
        <th>Ask (USDT/USDC)</th>
        <th>Spread (bps)</th>
        <th>Width (bps)</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>

  <div class="small" id="status"></div>
  <div class="small err" id="lastError"></div>

<script>
  // ---- Config ----
  const USDC = "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v";
  const USDT = "Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB";
  const DECIMALS = 1_000_000;                 // USDC/USDT are 6 decimals on Solana
  const SIZES_USD = [1000, 10_000, 50_000, 100_000];
  const REFRESH_MS = 20_000;                  // 8 requests/update => 24 req/min
  const SLIPPAGE_BPS = 1;                     // quoting slippage (doesn't change mid price much)
  const DEX_FILTER = "AlphaQ";                // ✅ force AlphaQ-only routing

  // ---- Key storage ----
  function getApiKey() {
    return (localStorage.getItem("JUP_API_KEY") || "").trim();
  }

  function updateKeyUI() {
    const k = getApiKey();
    const el = document.getElementById("keyState");
    if (k) {
      el.textContent = "set (using api.jup.ag)";
      el.className = "ok";
    } else {
      el.textContent = "not set (using lite-api.jup.ag fallback)";
      el.className = "err";
    }
    document.getElementById("hostState").textContent = new URL(baseUrl()).hostname;
  }

  function baseUrl() {
    // Prefer api.jup.ag (needs x-api-key). Fallback to lite-api.jup.ag if no key.
    return getApiKey() ? "https://api.jup.ag" : "https://lite-api.jup.ag";
  }

  // ---- Jupiter quote ----
  async function jupQuote(inputMint, outputMint, amountAtoms) {
    // Docs: GET /swap/v1/quote with inputMint, outputMint, amount, slippageBps, swapMode, dexes
    const url = new URL(baseUrl() + "/swap/v1/quote");
    url.searchParams.set("inputMint", inputMint);
    url.searchParams.set("outputMint", outputMint);
    url.searchParams.set("amount", String(amountAtoms));
    url.searchParams.set("swapMode", "ExactIn");
    url.searchParams.set("slippageBps", String(SLIPPAGE_BPS));

    // ✅ Force AlphaQ-only routing (matches UI manual "AMM sources → AlphaQ only")
    // Quote API supports `dexes` as a list (comma-separated). We set a single value.
    url.searchParams.set("dexes", DEX_FILTER);

    const headers = { "accept": "application/json" };
    const k = getApiKey();
    if (k) headers["x-api-key"] = k;

    const res = await fetch(url.toString(), { headers });
    const text = await res.text();

    if (!res.ok) {
      throw new Error(`HTTP ${res.status} from ${url.hostname}: ${text.slice(0, 220)}`);
    }

    let json;
    try { json = JSON.parse(text); }
    catch { throw new Error(`Bad JSON from ${url.hostname}: ${text.slice(0, 220)}`); }

    if (!json || typeof json.outAmount !== "string" || typeof json.inAmount !== "string") {
      throw new Error(`Unexpected response shape from ${url.hostname}: ${text.slice(0, 220)}`);
    }

    // Sanity: confirm AlphaQ label is actually used (defensive; if Jupiter changes label casing)
    // If routePlan exists, ensure every leg label is AlphaQ. If not, treat as error.
    if (Array.isArray(json.routePlan) && json.routePlan.length) {
      const labels = json.routePlan.map(x => x?.swapInfo?.label).filter(Boolean);
      const allAlphaQ = labels.length > 0 && labels.every(l => l === DEX_FILTER);
      if (!allAlphaQ) {
        throw new Error(`Not AlphaQ-only route: labels=${labels.join("→") || "unknown"}`);
      }
    }

    return json;
  }

  function fmt(x, d=9) {
    if (!Number.isFinite(x)) return "—";
    return x.toFixed(d);
  }

  function fmtBps(x, d=4) {
    if (!Number.isFinite(x)) return "—";
    return x.toFixed(d);
  }

  async function update() {
    const tbody = document.getElementById("rows");
    const status = document.getElementById("status");
    const lastError = document.getElementById("lastError");

    status.textContent = "Updating…";
    lastError.textContent = "";

    const out = [];

    for (const usd of SIZES_USD) {
      const amt = Math.round(usd * DECIMALS);

      try {
        // Bid: sell USDC -> USDT (ExactIn)
        const qBid = await jupQuote(USDC, USDT, amt);
        const bid_out = Number(qBid.outAmount); // USDT atoms received
        const bid_in  = Number(qBid.inAmount);  // USDC atoms sold
        const bid = bid_out / bid_in;           // USDT per USDC

        // Ask: sell USDT -> USDC (ExactIn), invert to USDT/USDC
        const qAsk = await jupQuote(USDT, USDC, amt);
        const ask_in  = Number(qAsk.inAmount);  // USDT atoms sold
        const ask_out = Number(qAsk.outAmount); // USDC atoms received
        const ask = ask_in / ask_out;           // USDT per USDC

        const spread_bps = (ask / bid - 1) * 10_000;
        const width_bps  = Math.abs(spread_bps);

        out.push({ usd, bid, ask, spread_bps, width_bps });
      } catch (e) {
        out.push({ usd, bid: NaN, ask: NaN, spread_bps: NaN, width_bps: NaN, err: String(e?.message || e) });
      }
    }

    tbody.innerHTML = out.map(r => `
      <tr>
        <td>${r.usd.toLocaleString()}</td>
        <td>${fmt(r.bid, 9)}</td>
        <td>${fmt(r.ask, 9)}</td>
        <td>${fmtBps(r.spread_bps, 4)}</td>
        <td>${fmtBps(r.width_bps, 4)}</td>
      </tr>
    `).join("");

    const errs = out.filter(x => x.err).map(x => `${x.usd}: ${x.err}`);
    if (errs.length) lastError.textContent = "Errors: " + errs.join(" | ");

    status.textContent =
      `Last update: ${new Date().toLocaleTimeString()} • host=${new URL(baseUrl()).hostname} • dexes=${DEX_FILTER} • refresh=${REFRESH_MS/1000}s`;
  }

  // UI buttons
  document.getElementById("setKeyBtn").addEventListener("click", () => {
    const k = prompt("Paste your Jupiter API key (stored in this browser as localStorage JUP_API_KEY):");
    if (k && k.trim()) {
      localStorage.setItem("JUP_API_KEY", k.trim());
      updateKeyUI();
      update();
    }
  });

  document.getElementById("clearKeyBtn").addEventListener("click", () => {
    localStorage.removeItem("JUP_API_KEY");
    updateKeyUI();
    update();
  });

  updateKeyUI();
  update();
  setInterval(update, REFRESH_MS);
</script>
</body>
</html>
